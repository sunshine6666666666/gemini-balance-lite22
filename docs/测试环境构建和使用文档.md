# Gemini Balance Lite 22 测试环境构建和使用文档

## 📋 测试环境概述

### 环境分离策略
- 🏠 **本地开发环境**：用于日常开发和快速测试
- 🔍 **预览测试环境**：用于功能验证和集成测试
- 🚀 **生产环境**：用于正式服务，自动部署

### 测试环境选择

我们推荐使用 **Vercel预览环境 + 本地开发** 的组合方案：

**优势：**
- ✅ **完全模拟生产环境**：Edge Functions运行时环境一致
- ✅ **零配置成本**：无需额外设置Docker或复杂环境
- ✅ **团队协作友好**：每个PR都有独立的预览URL
- ✅ **安全隔离**：预览环境与生产环境完全分离

## 🛠️ 环境搭建指南

### 前置要求
- Node.js 18+ 
- Git
- Vercel CLI

### 1. 安装Vercel CLI

```bash
# 全局安装Vercel CLI
npm install -g vercel

# 验证安装
vercel --version
```

### 2. 项目初始化

```bash
# 克隆项目（如果还没有）
git clone https://github.com/sunshine6666666666/gemini-balance-lite22.git
cd gemini-balance-lite22

# 登录Vercel账户
vercel login

# 初始化项目（首次运行）
vercel
```

### 3. 环境变量配置

#### 3.1 本地开发环境配置

创建本地环境变量文件：

```bash
# 复制示例配置
cp .env.sample .env.local

# 编辑本地配置
# 注意：.env.local 文件不会被提交到Git
```

`.env.local` 示例配置：
```bash
# 本地开发用的API Keys
BACKUP_API_KEYS=your_dev_api_key_1,your_dev_api_key_2,your_dev_api_key_3

# 本地开发用的可信API Keys
TRUSTED_API_KEYS=your_trusted_dev_key_1,your_trusted_dev_key_2

# 开发环境标识
NODE_ENV=development
```

#### 3.2 预览环境配置

创建预览环境变量文件：

```bash
# 创建预览环境配置
cp .env.sample .env.preview
```

`.env.preview` 示例配置：
```bash
# 预览环境用的API Keys（建议使用测试专用的Keys）
BACKUP_API_KEYS=your_preview_api_key_1,your_preview_api_key_2

# 预览环境用的可信API Keys
TRUSTED_API_KEYS=your_trusted_preview_key_1

# 预览环境标识
NODE_ENV=preview
```

#### 3.3 生产环境配置

在Vercel Dashboard中配置生产环境变量：

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 选择你的项目
3. 进入 **Settings** → **Environment Variables**
4. 添加以下变量：

```
Name: BACKUP_API_KEYS
Value: your_prod_api_key_1,your_prod_api_key_2,your_prod_api_key_3
Environment: Production

Name: TRUSTED_API_KEYS  
Value: your_trusted_prod_key_1,your_trusted_prod_key_2
Environment: Production
```

## 🚀 测试环境使用指南

### 本地开发环境

#### 启动本地开发服务器

```bash
# 启动本地开发服务器
vercel dev

# 服务器将在 http://localhost:3000 启动
```

#### 本地测试流程

1. **启动服务**：
```bash
vercel dev
```

2. **测试API端点**：
```bash
# 测试原生Gemini API
curl --location 'http://localhost:3000/v1beta/models/gemini-2.5-pro:generateContent' \
--header 'Content-Type: application/json' \
--header 'x-goog-api-key: your_test_api_key' \
--data '{
    "contents": [
        {
         "role": "user",
         "parts": [
            {
               "text": "Hello, this is a test"
            }
         ]
      }
    ]
}'

# 测试OpenAI兼容API
curl --location 'http://localhost:3000/chat/completions' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer your_test_api_key' \
--data '{
    "model": "gemini-2.5-pro",
    "messages": [
        {
            "role": "user",
            "content": "Hello, this is a test"
        }
    ]
}'
```

3. **查看日志**：
本地开发服务器会在终端显示详细的请求日志。

### 预览测试环境

#### 部署到预览环境

```bash
# 部署到预览环境（不影响生产）
vercel --prod=false

# 或者使用别名部署
vercel --prod=false --name=my-test-branch
```

#### 预览环境测试流程

1. **获取预览URL**：
部署完成后，Vercel会提供一个预览URL，例如：
`https://gemini-balance-lite22-abc123.vercel.app`

2. **测试完整功能**：
使用预览URL替换本地地址进行测试：

```bash
# 测试预览环境
curl --location 'https://gemini-balance-lite22-abc123.vercel.app/chat/completions' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer your_preview_api_key' \
--data '{
    "model": "gemini-2.5-pro",
    "messages": [
        {
            "role": "user",
            "content": "Hello from preview environment"
        }
    ]
}'
```

3. **验证负载均衡**：
发送多个请求，观察API Key轮询是否正常工作。

### 分支管理策略

#### 开发分支工作流

```bash
# 1. 创建功能分支
git checkout -b feature/add-audio-speech
git checkout -b fix/api-key-validation
git checkout -b refactor/code-structure

# 2. 在功能分支上开发
# ... 进行代码修改 ...

# 3. 本地测试
vercel dev
# 进行本地测试

# 4. 部署到预览环境测试
git add .
git commit -m "feat: add audio speech endpoint"
git push origin feature/add-audio-speech

# 5. 创建预览部署
vercel --prod=false

# 6. 预览环境测试通过后，合并到main
git checkout main
git merge feature/add-audio-speech
git push origin main
# 自动部署到生产环境
```

## 🧪 测试用例和验证

### 基础功能测试

#### 1. API端点测试

```bash
# 测试脚本：test-endpoints.sh
#!/bin/bash

BASE_URL="http://localhost:3000"  # 本地测试
# BASE_URL="https://your-preview-url.vercel.app"  # 预览环境测试

echo "Testing Gemini native API..."
curl -s "$BASE_URL/v1beta/models/gemini-2.5-pro:generateContent" \
  -H "Content-Type: application/json" \
  -H "x-goog-api-key: $TEST_API_KEY" \
  -d '{"contents":[{"role":"user","parts":[{"text":"Hello"}]}]}' \
  | jq .

echo "Testing OpenAI compatible API..."
curl -s "$BASE_URL/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TEST_API_KEY" \
  -d '{"model":"gemini-2.5-pro","messages":[{"role":"user","content":"Hello"}]}' \
  | jq .

echo "Testing models endpoint..."
curl -s "$BASE_URL/models" \
  -H "Authorization: Bearer $TEST_API_KEY" \
  | jq .
```

#### 2. 负载均衡测试

```bash
# 测试脚本：test-load-balancing.sh
#!/bin/bash

BASE_URL="http://localhost:3000"
API_KEY="your_trusted_test_key"

echo "Testing load balancing with multiple requests..."
for i in {1..5}; do
  echo "Request $i:"
  curl -s "$BASE_URL/chat/completions" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $API_KEY" \
    -d '{"model":"gemini-2.5-pro","messages":[{"role":"user","content":"Test '$i'"}]}' \
    | jq -r '.id'
  sleep 1
done
```

#### 3. 错误处理测试

```bash
# 测试无效API Key
curl -s "$BASE_URL/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer invalid_key" \
  -d '{"model":"gemini-2.5-pro","messages":[{"role":"user","content":"Test"}]}' \
  | jq .

# 测试无效请求格式
curl -s "$BASE_URL/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TEST_API_KEY" \
  -d '{"invalid":"request"}' \
  | jq .
```

### 性能测试

#### 并发测试

```bash
# 使用Apache Bench进行并发测试
ab -n 100 -c 10 -H "Authorization: Bearer $TEST_API_KEY" \
   -H "Content-Type: application/json" \
   -p test-payload.json \
   "$BASE_URL/chat/completions"
```

## 🔍 监控和调试

### 日志查看

#### 本地环境日志
本地开发时，所有日志直接显示在终端中。

#### 预览环境日志
```bash
# 查看预览环境日志
vercel logs https://your-preview-url.vercel.app
```

#### 生产环境日志
```bash
# 查看生产环境日志
vercel logs https://your-production-domain.com
```

### 调试技巧

#### 1. 启用详细日志
在环境变量中添加：
```bash
DEBUG=true
LOG_LEVEL=debug
```

#### 2. 使用浏览器开发者工具
- 打开Network面板查看请求详情
- 查看Console面板的错误信息
- 使用Sources面板进行断点调试

#### 3. API测试工具
推荐使用以下工具进行API测试：
- **Postman**：图形化API测试
- **curl**：命令行测试
- **HTTPie**：更友好的命令行工具

## 🚨 故障排除

### 常见问题

#### 1. 本地服务启动失败
```bash
# 检查Node.js版本
node --version  # 需要18+

# 检查Vercel CLI版本
vercel --version

# 重新安装依赖
npm install

# 清除Vercel缓存
vercel dev --debug
```

#### 2. API Key验证失败
- 检查环境变量配置是否正确
- 确认API Key格式正确
- 验证白名单配置

#### 3. 预览环境部署失败
```bash
# 查看部署日志
vercel logs

# 检查环境变量配置
vercel env ls

# 重新部署
vercel --prod=false --force
```

### 应急处理

#### 回滚到上一个版本
```bash
# 查看部署历史
vercel ls

# 回滚到指定版本
vercel rollback [deployment-url]
```

#### 紧急修复流程
1. 在本地快速修复问题
2. 部署到预览环境验证
3. 确认无误后推送到main分支
4. 监控生产环境状态

## 📋 测试检查清单

### 部署前检查
- [ ] 本地功能测试通过
- [ ] 预览环境测试通过
- [ ] 性能测试无明显下降
- [ ] 错误处理测试通过
- [ ] 环境变量配置正确

### 部署后检查
- [ ] 生产环境API响应正常
- [ ] 负载均衡功能正常
- [ ] 日志输出正常
- [ ] 监控指标正常
- [ ] 用户反馈正常

## 🔄 持续集成建议

### GitHub Actions配置
可以考虑添加自动化测试流程：

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '18'
      - run: npm install -g vercel
      - run: vercel dev &
      - run: sleep 10
      - run: ./test-endpoints.sh
```

这样可以确保每次代码提交都经过自动化测试验证。
